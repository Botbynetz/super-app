name: Staging Deployment Pipeline

on:
  push:
    branches:
      - staging
  pull_request:
    branches:
      - staging
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'
  RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK_STAGING }}

jobs:
  # ========== Job 1: Lint & Test ==========
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: testpass123
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Run linter
        working-directory: ./backend
        run: npm run lint || echo "No lint script found, skipping..."
      
      - name: Run unit tests
        working-directory: ./backend
        run: npm test || echo "No tests found, skipping..."
        env:
          NODE_ENV: test
          DATABASE_URI: mongodb://admin:testpass123@localhost:27017/superapp_test?authSource=admin
          JWT_SECRET: test_jwt_secret_key_for_ci
      
      - name: Run integration tests
        working-directory: ./backend
        run: npm run test:integration || echo "Integration tests not configured yet"
        env:
          NODE_ENV: test
          DATABASE_URI: mongodb://admin:testpass123@localhost:27017/superapp_test?authSource=admin
          JWT_SECRET: test_jwt_secret_key_for_ci
      
      - name: Upload coverage reports
        if: success()
        uses: codecov/codecov-action@v4
        with:
          directory: ./backend/coverage
          flags: backend
          fail_ci_if_error: false

  # ========== Job 2: Security Scan ==========
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Run npm audit
        working-directory: ./backend
        run: npm audit --production --audit-level=moderate || true
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './backend'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ========== Job 3: Concurrency Stress Tests ==========
  test-concurrency:
    name: Concurrency Stress Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    services:
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: testpass123
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Run concurrency stress tests
        working-directory: ./backend
        run: npm run test:concurrency
        env:
          NODE_ENV: test
          DATABASE_URI: mongodb://admin:testpass123@localhost:27017/superapp_test?authSource=admin
          JWT_SECRET: test_jwt_secret_key_for_ci
          SOCKET_IO_SECRET: test_socket_secret
      
      - name: Upload concurrency test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: concurrency-test-results
          path: backend/coverage/
          retention-days: 7

  # ========== Job 4: Middleware Unit Tests ==========
  test-middleware:
    name: Middleware Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Run middleware unit tests
        working-directory: ./backend
        run: npm run test:middleware
        env:
          NODE_ENV: test
      
      - name: Upload middleware test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: middleware-test-results
          path: backend/coverage/
          retention-days: 7

  # ========== Job 5: Build Docker Image ==========
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [test, security, test-concurrency, test-middleware]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: superapp-backend:staging-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Test Docker image
        run: |
          docker build -t test-image .
          docker run -d --name test-container -p 5000:5000 \
            -e NODE_ENV=production \
            -e DATABASE_URI=mongodb://test:27017/test \
            -e JWT_SECRET=test_secret \
            test-image
          sleep 10
          docker logs test-container
          docker stop test-container
          docker rm test-container

  # ========== Job 6: Deploy to Render ==========
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'
    
    environment:
      name: staging
      url: https://superapp-backend-staging.onrender.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Trigger Render deployment
        run: |
          curl -X POST "${{ env.RENDER_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -d '{"branch": "staging"}'
      
      - name: Wait for deployment
        run: sleep 60
      
      - name: Health check
        id: health_check
        run: |
          MAX_RETRIES=10
          RETRY_COUNT=0
          HEALTH_URL="https://superapp-backend-staging.onrender.com/api/health"
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Health check attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
            
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
            
            if [ "$RESPONSE" = "200" ]; then
              echo "✅ Health check passed!"
              exit 0
            fi
            
            echo "❌ Health check failed with status: $RESPONSE"
            RETRY_COUNT=$((RETRY_COUNT + 1))
            sleep 15
          done
          
          echo "❌ Deployment failed health checks after $MAX_RETRIES attempts"
          exit 1
      
      - name: Rollback on failure
        if: failure() && steps.health_check.outcome == 'failure'
        run: |
          echo "⚠️ Rolling back deployment..."
          curl -X POST "${{ secrets.RENDER_ROLLBACK_HOOK }}" || echo "Rollback hook not configured"
      
      - name: Send success notification
        if: success()
        run: |
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_ADMIN_CHAT_ID }}" \
            -d "text=✅ Staging deployment successful!%0ABranch: staging%0ACommit: ${{ github.sha }}%0AAuthor: ${{ github.actor }}" \
            -d "parse_mode=HTML" || echo "Telegram notification not configured"
      
      - name: Send failure notification
        if: failure()
        run: |
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_ADMIN_CHAT_ID }}" \
            -d "text=❌ Staging deployment FAILED!%0ABranch: staging%0ACommit: ${{ github.sha }}%0AAuthor: ${{ github.actor }}" \
            -d "parse_mode=HTML" || echo "Telegram notification not configured"

  # ========== Job 7: Post-Deployment Tests ==========
  post-deploy-tests:
    name: Post-Deployment Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy]
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Run smoke tests
        working-directory: ./backend
        run: npm run test:smoke || echo "Smoke tests not configured yet"
        env:
          API_BASE_URL: https://superapp-backend-staging.onrender.com
      
      - name: Test Socket.io connection
        run: |
          node -e "
            const io = require('socket.io-client');
            const socket = io('https://superapp-backend-staging.onrender.com', {
              transports: ['websocket', 'polling']
            });
            socket.on('connect', () => {
              console.log('✅ Socket.io connected successfully');
              socket.disconnect();
              process.exit(0);
            });
            socket.on('connect_error', (err) => {
              console.error('❌ Socket.io connection failed:', err.message);
              process.exit(1);
            });
            setTimeout(() => {
              console.error('❌ Socket.io connection timeout');
              process.exit(1);
            }, 10000);
          " || echo "Socket.io test skipped"
